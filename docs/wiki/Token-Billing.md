# Token Tracking & Billing

## Overview

Every AI API call is tracked with full metadata. Users can view their usage in a dashboard with drill-down by agent, provider, model, and per-request detail.

## What Is Tracked

Each API request records:
- **Agent name** — which agent made the call
- **Provider** — anthropic, openai, or google
- **Model** — exact model ID (e.g., claude-sonnet-4-6)
- **API key hash** — SHA-256 of the key used (never the key itself)
- **Input tokens** — tokens sent to the model
- **Output tokens** — tokens generated by the model
- **Total tokens** — sum of input + output
- **Cost estimate** — USD estimate based on model pricing

## Cost Estimation

Per-million-token pricing used for estimates:

| Model | Input | Output |
|-------|-------|--------|
| claude-opus-4-6 | $15 | $75 |
| claude-sonnet-4-6 | $3 | $15 |
| claude-haiku-4-5 | $0.80 | $4 |
| gpt-5.2 | $2.50 | $10 |
| gpt-5.2-pro | $15 | $60 |
| gemini-2.5-flash | $0.15 | $0.60 |

## Safety Limits

- **Default limit:** 500,000 tokens per session
- **Warning:** Shown at 80% of limit
- **Pause:** At 100%, orchestration pauses and user must confirm to continue
- Limits are configurable per-session

## API Endpoints

- `GET /api/usage` — List all records (filterable by chatId)
- `GET /api/usage/summary` — Aggregate totals
- `GET /api/usage/by-agent` — Grouped by agent
- `GET /api/usage/by-provider` — Grouped by provider + model

## Real-Time Cost Display

A usage badge in the sidebar footer shows:
- **Total spent** across all chats (updated in real time via `token_usage` WebSocket events)
- **This chat** cost when a chat is active

Clicking the badge opens the full usage dashboard as a modal overlay.

## Dashboard Views

1. **Overview** — Total tokens, cost, request count
2. **By Agent** — Token usage per agent
3. **By Provider** — Token usage per provider/model
4. **Request Log** — Per-request detail table
